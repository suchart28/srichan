<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>แผนที่สำรวจการใช้ประโยชน์ที่ดิน (Mobile-first)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map { height:100%; margin:0; padding:0; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial; }

    /* Mobile friendly controls */
    .topbar {
      position: absolute; left:0; right:0; top:0; height:48px; display:flex; align-items:center; padding:6px 10px; gap:8px; z-index:500;
      background: rgba(255,255,255,0.92); box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    }
    .title { font-weight:600; font-size:16px; }
    .btn { background:#1976d2; color:white; border:none; padding:8px 10px; border-radius:8px; font-size:14px; }

    /* Floating action button */
    .fab {
      position: absolute; right:16px; bottom:20px; z-index:600;
    }
    .fab button { width:56px; height:56px; border-radius:50%; background:#0b8043; color:white; border:none; font-size:26px; box-shadow:0 4px 12px rgba(0,0,0,0.25); }

    /* Survey form modal */
    .modal {
      position: absolute; left:8px; right:8px; bottom:90px; z-index:700; background:rgba(255,255,255,0.98); border-radius:12px; padding:12px; box-shadow:0 8px 20px rgba(0,0,0,0.2);
      display:none; max-height:60vh; overflow:auto;
    }
    .modal header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    label { display:block; font-size:13px; margin-top:8px; }
    select,input[type=text],textarea { width:100%; padding:8px; border-radius:8px; border:1px solid #ddd; font-size:14px; box-sizing:border-box; }
    textarea { min-height:84px; resize:vertical; }
    .row { display:flex; gap:8px; }
    .row .col { flex:1; }

    /* small popup hint for draggable marker */
    .hint { font-size:12px; color:#555; margin-top:6px; }

    @media(min-width:720px){
      .modal { left:20%; right:20%; bottom:20px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="topbar">
    <div class="title">แผนที่สำรวจ - ถนนศรีจันทร์, ขอนแก่น</div>
    <div style="margin-left:auto">
      <button id="toggleCadastral" class="btn">เปิดแผนที่แปลงที่ดิน</button>
    </div>
  </div>

  <div class="modal" id="surveyModal">
    <header>
      <strong>ฟอร์มสำรวจการใช้ประโยชน์ที่ดิน</strong>
      <button id="closeForm" class="btn" style="background:#777;">ปิด</button>
    </header>
    <div>
      <label>ประเภทสถานที่</label>
      <select id="placeType">
        <option value="ร้านค้า">ร้านค้า</option>
        <option value="ร้านอาหาร">ร้านอาหาร</option>
        <option value="สถานบริการ">สถานบริการ</option>
        <option value="บ้านพักเปิด">บ้านพักเปิด</option>
        <option value="บ้านพักปิด">บ้านพักปิด</option>
        <option value="พื้นที่รกร้าง">พื้นที่รกร้าง</option>
        <option value="ที่ดินเปล่า">ที่ดินเปล่า</option>
      </select>

      <label>รายละเอียด</label>
      <textarea id="details" placeholder="อธิบายการใช้ประโยชน์ของพื้นที่"></textarea>

      <div class="row" style="margin-top:8px;">
        <div class="col"><button id="useMyLocation" class="btn" style="width:100%">ใช้พิกัดปัจจุบัน</button></div>
        <div class="col"><button id="centerMap" class="btn" style="background:#555; width:100%">ย้ายมาใกล้ฉัน</button></div>
      </div>

      <div class="hint">คุณสามารถลากหมุดเพื่อปรับตำแหน่งได้</div>
      <div style="display:flex; gap:8px; margin-top:12px;">
        <button id="saveSurvey" class="btn" style="flex:1">ส่งข้อมูลสำรวจ</button>
        <button id="clearAll" class="btn" style="flex:1; background:#e53935">ลบทั้งหมด (Local)</button>
      </div>
    </div>
  </div>

  <div class="fab">
    <button id="openForm">+</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Config ---
    const defaultCenter = [16.4288, 102.85056]; // ถนนศรีจันทร์ ราวๆ กลางเมืองขอนแก่น
    const defaultZoom = 16;

    // color mapping by type
    const colorByType = {
      'ร้านค้า': 'blue',
      'ร้านอาหาร': 'orange',
      'สถานบริการ': 'purple',
      'บ้านพักเปิด': 'green',
      'บ้านพักปิด': 'gray',
      'พื้นที่รกร้าง': 'black',
      'ที่ดินเปล่า': 'brown'
    };

    // --- Map setup ---
    const map = L.map('map', { zoomControl:false }).setView(defaultCenter, defaultZoom);

    // satellite imagery (Esri) plus transparent OSM overlay for place labels
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
    const osmLabels = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, opacity:0.9 });

    satellite.addTo(map);
    osmLabels.addTo(map);

    // add zoom control bottom-right for mobile
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // --- Cadastral layer (กรมที่ดิน) ---
    // Example WMS endpoint discovered from public posts; layer name may vary.
    // If this WMS requires an intranet or credentials it may not load from all networks.
    const cadastralWMSurl = 'http://110.164.49.68:8081/geoserver/WMSDOL/wms';

    // NOTE: you may need to change 'layer' to the correct layer name provided by the service.
    const cadastral = L.tileLayer.wms(cadastralWMSurl, {
      layers: 'parcel', // <- replace with the correct layer name if needed
      format: 'image/png',
      transparent: true,
      attribution: 'กรมที่ดิน'
    });

    // toggle cadastral with the top button
    const toggleBtn = document.getElementById('toggleCadastral');
    let cadastralVisible = false;
    toggleBtn.addEventListener('click', ()=>{
      cadastralVisible = !cadastralVisible;
      if(cadastralVisible){ cadastral.addTo(map); toggleBtn.textContent = 'ปิดแผนที่แปลงที่ดิน'; }
      else { cadastral.remove(); toggleBtn.textContent = 'เปิดแผนที่แปลงที่ดิน'; }
    });

    // layer control (optional)
    const baseMaps = { 'Satellite': satellite, 'OSM (labels)': osmLabels };
    const overlayMaps = { 'แปลงที่ดิน (กรมที่ดิน)': cadastral };
    L.control.layers(baseMaps, overlayMaps, { position:'topleft', collapsed:true }).addTo(map);

    // --- Survey markers handling (LocalStorage as simple backend) ---
    const STORAGE_KEY = 'land_survey_markers_v1';

    function loadMarkers(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      try{ return JSON.parse(raw); }catch(e){ return []; }
    }
    function saveMarkers(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

    let markers = loadMarkers(); // array of {lat,lng,type,details,timestamp,id}
    const markerLayer = L.layerGroup().addTo(map);

    function mkIcon(color){
      // small colored circle (Leaflet divIcon)
      return L.divIcon({ className: 'custom-pin', html: `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="36" viewBox="0 0 24 24"><path fill="${color}" d="M12 2C8.14 2 5 5.14 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.86-3.14-7-7-7z"/></svg>`, iconSize:[28,36], iconAnchor:[14,36] });
    }

    function renderMarkers(){
      markerLayer.clearLayers();
      markers.forEach(m=>{
        const color = colorByType[m.type] || 'blue';
        const marker = L.marker([m.lat,m.lng], { icon: mkIcon(color) });
        marker.bindPopup(`<strong>${m.type}</strong><br/><small>${new Date(m.timestamp).toLocaleString()}</small><hr style='margin:6px 0'/><div>${m.details||''}</div>`);
        markerLayer.addLayer(marker);
      });
    }
    renderMarkers();

    // --- Survey form + temporary draggable marker ---
    const openBtn = document.getElementById('openForm');
    const modal = document.getElementById('surveyModal');
    const closeForm = document.getElementById('closeForm');
    const useMyLocBtn = document.getElementById('useMyLocation');
    const centerMapBtn = document.getElementById('centerMap');
    const saveBtn = document.getElementById('saveSurvey');
    const clearBtn = document.getElementById('clearAll');

    let tempMarker = null;

    function openModal(){ modal.style.display='block'; if(!tempMarker){ tempMarker = L.marker(map.getCenter(), { draggable:true }).addTo(map); tempMarker.bindPopup('ลากเพื่อปรับตำแหน่ง').openPopup(); } }
    function closeModal(){ modal.style.display='none'; if(tempMarker){ map.removeLayer(tempMarker); tempMarker = null; } }

    openBtn.addEventListener('click', openModal);
    closeForm.addEventListener('click', closeModal);

    useMyLocBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation){ alert('เบราว์เซอร์ไม่รองรับการระบุตำแหน่ง'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        if(!tempMarker){ tempMarker = L.marker([lat,lng], { draggable:true }).addTo(map); }
        else { tempMarker.setLatLng([lat,lng]); }
        map.setView([lat,lng], 18);
      }, err=>{ alert('ไม่สามารถรับพิกัดปัจจุบันได้: '+err.message); }, { enableHighAccuracy:true });
    });

    centerMapBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation){ alert('เบราว์เซอร์ไม่รองรับการระบุตำแหน่ง'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{ map.setView([pos.coords.latitude,pos.coords.longitude], 18); }, err=>{ alert('ไม่สามารถรับพิกัดของคุณได้: '+err.message); }, { enableHighAccuracy:true });
    });

    saveBtn.addEventListener('click', ()=>{
      const type = document.getElementById('placeType').value;
      const details = document.getElementById('details').value;
      let latlng;
      if(tempMarker){ latlng = tempMarker.getLatLng(); }
      else { latlng = map.getCenter(); }
      const newItem = { id: Date.now(), lat: latlng.lat, lng: latlng.lng, type, details, timestamp: Date.now() };
      markers.push(newItem);
      saveMarkers(markers);
      renderMarkers();
      alert('ส่งข้อมูลเรียบร้อย');
      closeModal();
    });

    clearBtn.addEventListener('click', ()=>{
      if(!confirm('ลบข้อมูลทั้งหมดในเครื่องนี้ (localStorage)?')) return;
      markers = []; saveMarkers(markers); renderMarkers();
    });

    // allow tapping existing markers to show popup (already bound in renderMarkers)

    // --- small UX tweaks: tap map to set / move temp marker when modal open ---
    map.on('click', e=>{
      if(modal.style.display==='block'){
        if(!tempMarker) tempMarker = L.marker(e.latlng, { draggable:true }).addTo(map);
        else tempMarker.setLatLng(e.latlng);
      }
    });

    // --- Ensure map fills mobile viewport height properly (workaround for mobile browsers) ---
    function setMapHeight(){ document.getElementById('map').style.height = (window.innerHeight) + 'px'; map.invalidateSize(); }
    window.addEventListener('resize', setMapHeight); setMapHeight();

    // --- Optional: show clustered markers or load from server ---
    // For production, replace localStorage with API calls to your backend (POST / GET), and secure the cadastral WMS access if required.

  </script>
</body>
</html>