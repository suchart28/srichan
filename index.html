<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô (‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; font-family: 'Sarabun', sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏° (Floating Action Button) */
        .fab-btn {
            position: absolute;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 60px;
            font-size: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            cursor: pointer;
            border: none;
            transition: transform 0.2s;
        }
        .fab-btn:active { transform: scale(0.9); }

        /* Modal Form Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        input, select, textarea { 
            width: 100%; padding: 12px; 
            border: 1px solid #ddd; border-radius: 8px; 
            box-sizing: border-box; font-family: 'Sarabun', sans-serif; font-size: 16px;
        }
        textarea { resize: vertical; }
        
        /* Coordinate Input Style */
        #latlng-input {
            background-color: #f1f8ff;
            color: #0056b3;
            font-weight: bold;
            text-align: center;
            border: 1px dashed #007bff;
            cursor: not-allowed;
        }

        /* Buttons */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-locate { 
            background-color: #28a745; color: white; 
            margin-top: 8px; width: 100%; padding: 10px; border: none; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        /* Popup Styling */
        .leaflet-popup-content { font-family: 'Sarabun', sans-serif; font-size: 14px; line-height: 1.6; }
        .popup-header { font-size: 16px; font-weight: bold; color: #007bff; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 5px; }
        .popup-row { margin-bottom: 4px; }
        .popup-label { font-weight: bold; color: #555; }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <button class="fab-btn" onclick="openForm()">+</button>

    <div id="modalForm" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; text-align:center;">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏ß‡∏à</h3>
            
            <div class="form-group">
                <label>üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)</label>
                <input type="text" id="latlng-input" readonly value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏">
                <button class="btn btn-locate" onclick="getCurrentLocation()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
                    ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (GPS)
                </button>
            </div>

            <div class="form-group">
                <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
                <select id="placeType">
                    <option value="shop">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                    <option value="restaurant">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                    <option value="service">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
                    <option value="residential">‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢</option>
                    <option value="wasteland">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏Å‡∏£‡πâ‡∏≤‡∏á</option>
                    <option value="vacant">‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏•‡πà‡∏≤</option>
                </select>
            </div>

            <div class="form-group">
                <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                <textarea id="details" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏∑‡∏≠, ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πâ 2 ‡∏ä‡∏±‡πâ‡∏ô, ‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡∏°‡∏µ‡∏£‡∏±‡πâ‡∏ß‡∏•‡πâ‡∏≠‡∏°"></textarea>
            </div>

            <div class="form-group">
                <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                <select id="status">
                    <option value="Open">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                    <option value="Closed">‡∏õ‡∏¥‡∏î/‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</option>
                </select>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-primary" onclick="submitForm()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        // ‡πÉ‡∏™‡πà Web App URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google Apps Script ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const SCRIPT_URL = 'Yhttps://script.google.com/macros/s/AKfycbxKJ_kAK7tDqM3mMXLy-P5Eid-0mLz64-jBvlXPr6jwEuCPUFC8VR8pzUrxgJuOTGdg/exec'; 
        
        // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ñ‡∏ô‡∏ô‡∏®‡∏£‡∏µ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô)
        const START_LAT = 16.426;
        const START_LNG = 102.835;

        // ==========================================
        // 2. MAP SETUP
        // ==========================================
        const map = L.map('map', {
            center: [START_LAT, START_LNG],
            zoom: 16,
            zoomControl: false 
        });

        // ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô (Clean)
        const cleanMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy;OpenStreetMap, &copy;CartoDB',
            maxZoom: 20
        }).addTo(map);

        // ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°
        const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        // ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏ô‡∏ô/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (Label) ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô (Optional)
        const labelMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
            pane: 'overlayPane'
        });

        const baseMaps = {
            "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô": cleanMap,
            "‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°": satelliteMap
        };
        
        const overlayMaps = {
            "‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏ô‡∏ô/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà": labelMap
        };

        L.control.layers(baseMaps, overlayMaps).addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // ==========================================
        // 3. DATA HANDLING
        // ==========================================
        let tempMarker = null;
        let allMarkers = L.layerGroup().addTo(map);

        const typeColors = {
            'shop': '#3498db',       // Blue
            'restaurant': '#e67e22', // Orange
            'service': '#9b59b6',    // Purple
            'residential': '#2ecc71',// Green
            'wasteland': '#7f8c8d',  // Gray
            'vacant': '#95a5a6'      // Light Gray
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        function formatThaiDate(dateString) {
            if (!dateString) return "-";
            const date = new Date(dateString);
            return date.toLocaleString('th-TH', {
                year: 'numeric',
                month: 'short', // ‡∏°.‡∏Ñ.
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function loadData() {
            fetch(SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                allMarkers.clearLayers();
                data.forEach(row => {
                    // Google Sheet Column Order:
                    // [0]Timestamp, [1]Lat, [2]Lng, [3]Type, [4]Details, [5]Status
                    const timestamp = row[0];
                    const lat = parseFloat(row[1]);
                    const lng = parseFloat(row[2]);
                    const type = row[3];
                    const details = row[4];
                    const status = row[5];

                    if(!isNaN(lat)) {
                        const color = typeColors[type] || 'red';
                        
                        const marker = L.circleMarker([lat, lng], {
                            radius: 8,
                            fillColor: color,
                            color: "#fff",
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.9
                        });

                        // Popup ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° Timestamp
                        const popupContent = `
                            <div class="popup-header">${getTypeName(type)}</div>
                            <div class="popup-row"><span class="popup-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span> 
                                ${status === 'Open' ? '<span style="color:green; font-weight:bold;">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>' : '<span style="color:red; font-weight:bold;">‡∏õ‡∏¥‡∏î/‡∏£‡πâ‡∏≤‡∏á</span>'}
                            </div>
                            <div class="popup-row"><span class="popup-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</span> ${details}</div>
                            <hr style="margin: 5px 0; border: 0; border-top: 1px solid #eee;">
                            <div style="font-size: 12px; color: #888; text-align: right;">
                                üïí ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó: ${formatThaiDate(timestamp)}
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                        allMarkers.addLayer(marker);
                    }
                });
            })
            .catch(err => console.error("Error loading data:", err));
        }

        function getTypeName(typeKey) {
            const names = {
                'shop': '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', 'restaurant': '‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 'service': '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
                'residential': '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢', 'wasteland': '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏Å‡∏£‡πâ‡∏≤‡∏á', 'vacant': '‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏•‡πà‡∏≤'
            };
            return names[typeKey] || typeKey;
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
        loadData();

        // ==========================================
        // 4. FORM & INTERACTION
        // ==========================================
        
        function openForm() {
            const center = map.getCenter();
            createTempMarker(center.lat, center.lng);
            document.getElementById('modalForm').style.display = 'flex';
        }

        function closeForm() {
            document.getElementById('modalForm').style.display = 'none';
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }

        function createTempMarker(lat, lng) {
            if (tempMarker) map.removeLayer(tempMarker);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏ö‡∏ö Draggable
            tempMarker = L.marker([lat, lng], { draggable: true }).addTo(map);
            
            // Update ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            updateLatLngDisplay(lat, lng);
            map.panTo([lat, lng]);

            // Event: ‡∏Ç‡∏ì‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å (Update real-time)
            tempMarker.on('drag', function(e) {
                const coord = e.target.getLatLng();
                updateLatLngDisplay(coord.lat, coord.lng);
            });

            // Event: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à
            tempMarker.on('dragend', function(e) {
                const coord = e.target.getLatLng();
                updateLatLngDisplay(coord.lat, coord.lng);
                map.panTo(coord);
            });
        }

        function updateLatLngDisplay(lat, lng) {
            const input = document.getElementById('latlng-input');
            input.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        function getCurrentLocation() {
            const btn = document.querySelector('.btn-locate');
            const oldText = btn.innerHTML;
            btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    createTempMarker(lat, lng);
                    btn.innerHTML = oldText;
                }, (err) => {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ: ' + err.message);
                    btn.innerHTML = oldText;
                }, { enableHighAccuracy: true });
            } else {
                alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS');
                btn.innerHTML = oldText;
            }
        }

        function submitForm() {
            if (!tempMarker) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î');
                return;
            }

            const latLng = tempMarker.getLatLng();
            const formData = {
                lat: latLng.lat,
                lng: latLng.lng,
                type: document.getElementById('placeType').value,
                details: document.getElementById('details').value,
                status: document.getElementById('status').value
            };

            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerText;
            btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            btn.disabled = true;

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            }).then(() => {
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                closeForm();
                loadData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° Timestamp ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                
                // Reset
                document.getElementById('details').value = '';
                btn.innerText = originalText;
                btn.disabled = false;
            }).catch(err => {
                console.error(err);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                btn.innerText = originalText;
                btn.disabled = false;
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('modalForm');
            if (event.target == modal) {
                closeForm();
            }
        }
    </script>
</body>
</html>
