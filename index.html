<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô (‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; font-family: 'Sarabun', sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* --- 1. Dashboard ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (Overlay) --- */
        .stats-panel {
            position: absolute;
            top: 50%; /* ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
            left: 10px; /* ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
            transform: translateY(-50%);
            width: 160px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000; /* ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ï‡πâ Modal */
            font-size: 14px;
            backdrop-filter: blur(4px);
            border: 1px solid #eee;
        }

        .stats-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            text-align: center;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .stat-label { display: flex; align-items: center; gap: 6px; }
        
        /* ‡∏à‡∏∏‡∏î‡∏™‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó */
        .color-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .stat-count { font-weight: bold; color: #555; }

        /* Total Row Style */
        .stat-total {
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px solid #ddd;
            font-weight: bold;
            font-size: 1.1em;
            color: #007bff;
        }

        /* --- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏° (FAB) --- */
        .fab-btn {
            position: absolute;
            bottom: 30px;
            right: 20px;
            width: 60px; height: 60px;
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 60px;
            font-size: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            cursor: pointer;
            border: none;
        }

        /* --- Modal Styles --- */
        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
            backdrop-filter: blur(3px);
            padding: 10px; box-sizing: border-box;
        }
        .modal-content {
            background-color: white; padding: 15px; border-radius: 15px;
            width: 100%; max-width: 400px; max-height: 95vh;
            overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
        }
        
        /* Mini Map Style */
        #mini-map { width: 100%; height: 200px; border-radius: 8px; border: 2px solid #ddd; margin-bottom: 10px; }

        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; font-size: 14px; }
        input, select, textarea { 
            width: 100%; padding: 10px; 
            border: 1px solid #ddd; border-radius: 8px; 
            box-sizing: border-box; font-family: 'Sarabun', sans-serif; font-size: 14px;
        }
        
        #latlng-input { background-color: #f1f8ff; color: #0056b3; font-weight: bold; text-align: center; font-size: 12px; }

        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-locate { 
            background-color: #28a745; color: white; width: 100%; 
            margin-top: 5px; padding: 8px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        .leaflet-popup-content { font-family: 'Sarabun', sans-serif; font-size: 14px; }
        .popup-header { font-weight: bold; color: #007bff; border-bottom: 1px solid #eee; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div class="stats-panel" id="statsPanel">
        <div class="stats-title">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        <div id="statsContent">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
    
    <button class="fab-btn" onclick="openForm()">+</button>

    <div id="modalForm" class="modal">
        <div class="modal-content">
            <h3 style="margin: 0 0 10px 0; text-align:center;">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            
            <div class="form-group">
                <label>üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                <div id="mini-map"></div>
                <input type="text" id="latlng-input" readonly value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...">
                <button class="btn btn-locate" onclick="getCurrentLocationForMiniMap()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
                    ‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                </button>
            </div>

            <div class="form-group">
                <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
                <select id="placeType">
                    <option value="shop">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                    <option value="restaurant">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                    <option value="service">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
                    <option value="government">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</option> <option value="residential">‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢</option>
                    <option value="vendor">‡πÅ‡∏ú‡∏á‡∏•‡∏≠‡∏¢</option> <option value="wasteland">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏Å‡∏£‡πâ‡∏≤‡∏á</option>
                    <option value="vacant">‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏•‡πà‡∏≤</option>
                </select>
            </div>

            <div class="form-group">
                <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                <textarea id="details" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
            </div>

            <div class="form-group">
                <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                <select id="status">
                    <option value="Open">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                    <option value="Closed">‡∏õ‡∏¥‡∏î/‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</option>
                </select>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-primary" onclick="submitForm()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- CONFIG ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKJ_kAK7tDqM3mMXLy-P5Eid-0mLz64-jBvlXPr6jwEuCPUFC8VR8pzUrxgJuOTGdg/exec'; // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const START_LAT = 16.426;
        const START_LNG = 102.835;

        // --- MAP SETUP ---
        const map = L.map('map', { zoomControl: false }).setView([START_LAT, START_LNG], 16);
        
        const cleanMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: 'CartoDB', maxZoom: 20
        }).addTo(map);
        
        const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri'
        });

        const labelMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png');

        L.control.layers(
            { "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î": cleanMap, "‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°": satelliteMap }, 
            { "‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏ô‡∏ô": labelMap }
        ).addTo(map);
        
        L.control.zoom({ position: 'topright' }).addTo(map);

        // --- DATA & CONFIG ---
        let allMarkers = L.layerGroup().addTo(map);
        
        // 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏´‡∏°‡πà
        const typeConfig = {
            'shop':         { name: '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', color: '#3498db' },       // ‡∏ü‡πâ‡∏≤
            'restaurant':   { name: '‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', color: '#e67e22' },     // ‡∏™‡πâ‡∏°
            'service':      { name: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', color: '#9b59b6' },    // ‡∏°‡πà‡∏ß‡∏á
            'government':   { name: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£', color: '#2c3e50' }, // ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° (New)
            'residential':  { name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢', color: '#2ecc71' },  // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
            'vendor':       { name: '‡πÅ‡∏ú‡∏á‡∏•‡∏≠‡∏¢', color: '#f1c40f' },        // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏ó‡∏≠‡∏á (New)
            'wasteland':    { name: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏Å‡∏£‡πâ‡∏≤‡∏á', color: '#7f8c8d' }, // ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°
            'vacant':       { name: '‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏•‡πà‡∏≤', color: '#bdc3c7' }    // ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô
        };

        // --- FUNCTIONS ---

        function formatThaiDate(dateString) {
            if (!dateString) return "-";
            return new Date(dateString).toLocaleString('th-TH', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        function loadData() {
            fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                allMarkers.clearLayers();
                
                // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                let stats = {};
                let totalCount = 0;
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                for (let key in typeConfig) {
                    stats[key] = 0;
                }

                data.forEach(row => {
                    const [timestamp, lat, lng, type, details, status] = row;
                    
                    if(!isNaN(parseFloat(lat))) {
                        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                        if (stats.hasOwnProperty(type)) {
                            stats[type]++;
                        } else {
                            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏à‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏õ‡∏•‡∏Å‡∏õ‡∏•‡∏≠‡∏° ‡∏Å‡πá‡∏ô‡∏±‡∏ö‡∏£‡∏ß‡∏°‡πÑ‡∏õ
                            stats[type] = 1;
                        }
                        totalCount++;

                        // ‡∏ß‡∏≤‡∏î‡∏´‡∏°‡∏∏‡∏î
                        const config = typeConfig[type] || { name: type, color: 'red' };
                        const marker = L.circleMarker([lat, lng], {
                            radius: 8, fillColor: config.color,
                            color: "#fff", weight: 2, fillOpacity: 0.9
                        });
                        marker.bindPopup(`
                            <div class="popup-header">${config.name}</div>
                            <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${status}<br>
                            <b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${details}<br>
                            <small style="color:gray">${formatThaiDate(timestamp)}</small>
                        `);
                        allMarkers.addLayer(marker);
                    }
                });

                // 5. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Dashboard ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                updateStatsPanel(stats, totalCount);
            });
        }

        function updateStatsPanel(stats, total) {
            let html = '';
            
            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô typeConfig
            for (let key in typeConfig) {
                const conf = typeConfig[key];
                const count = stats[key] || 0;
                
                html += `
                    <div class="stat-row">
                        <div class="stat-label">
                            <span class="color-dot" style="background-color: ${conf.color}"></span>
                            ${conf.name}
                        </div>
                        <div class="stat-count">${count}</div>
                    </div>
                `;
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏£‡∏ß‡∏° (Total) ‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ö‡∏ô‡∏™‡∏∏‡∏î ‡∏ï‡∏≤‡∏°‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå (‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π List ‡∏Å‡πà‡∏≠‡∏ô)
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏≠‡∏≤ Total ‡πÑ‡∏ß‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢ block ‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô for loop
            let totalHtml = `
                <div class="stat-row stat-total">
                    <div class="stat-label">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    <div class="stat-count">${total}</div>
                </div>
            `;
            
            // ‡πÄ‡∏≠‡∏≤ Total ‡πÑ‡∏ß‡πâ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡∏≤‡∏° Request
            document.getElementById('statsContent').innerHTML = totalHtml + html;
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        loadData();

        // --- MINI MAP & FORM LOGIC ---
        let miniMap, miniMarker;

        function initMiniMap() {
            if (miniMap) return;
            miniMap = L.map('mini-map', { zoomControl: false, attributionControl: false });
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(miniMap);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png').addTo(miniMap);
        }

        function openForm() {
            document.getElementById('modalForm').style.display = 'flex';
            initMiniMap();
            const center = map.getCenter();
            setTimeout(() => {
                miniMap.invalidateSize();
                miniMap.setView(center, 18);
                updateMiniMarker(center.lat, center.lng);
            }, 200);
        }

        function updateMiniMarker(lat, lng) {
            if (miniMarker) miniMap.removeLayer(miniMarker);
            miniMarker = L.marker([lat, lng], { draggable: true }).addTo(miniMap);
            updateInput(lat, lng);
            miniMarker.on('drag', function(e) {
                const c = e.target.getLatLng();
                updateInput(c.lat, c.lng);
            });
        }

        function updateInput(lat, lng) {
            document.getElementById('latlng-input').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        function getCurrentLocationForMiniMap() {
            const btn = document.querySelector('.btn-locate');
            const oldText = btn.innerHTML;
            btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    const lat = p.coords.latitude; const lng = p.coords.longitude;
                    miniMap.setView([lat, lng], 19);
                    updateMiniMarker(lat, lng);
                    btn.innerHTML = oldText;
                }, () => { alert('‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠'); btn.innerHTML = oldText; }, {enableHighAccuracy: true});
            } else { alert('Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS'); }
        }

        function closeForm() {
            document.getElementById('modalForm').style.display = 'none';
        }

        function submitForm() {
            if (!miniMarker) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î');
            const latLng = miniMarker.getLatLng();
            const formData = {
                lat: latLng.lat, lng: latLng.lng,
                type: document.getElementById('placeType').value,
                details: document.getElementById('details').value,
                status: document.getElementById('status').value
            };
            const btn = document.querySelector('.btn-primary');
            btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...'; btn.disabled = true;

            fetch(SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            }).then(() => {
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); closeForm(); loadData();
                document.getElementById('details').value = '';
                btn.innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; btn.disabled = false;
            }).catch(err => { alert('Error'); btn.disabled = false; });
        }

        window.onclick = function(e) { if (e.target == document.getElementById('modalForm')) closeForm(); }
    </script>
</body>
</html>
