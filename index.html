<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ระบบสำรวจการใช้ประโยชน์ที่ดิน</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; padding: 0; font-family: 'Sarabun', sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* ปุ่มเปิดฟอร์ม (Floating Action Button) */
        .fab-btn {
            position: absolute;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 60px;
            font-size: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            cursor: pointer;
            border: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
            padding: 10px; /* กันขอบชิดจอเกินไปในมือถือ */
            box-sizing: border-box;
        }
        .modal-content {
            background-color: white;
            padding: 15px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        /* Mini Map Style */
        #mini-map {
            width: 100%;
            height: 250px; /* ความสูงแผนที่ย่อ */
            border-radius: 8px;
            border: 2px solid #ddd;
            margin-bottom: 10px;
        }

        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; font-size: 14px; }
        input, select, textarea { 
            width: 100%; padding: 10px; 
            border: 1px solid #ddd; border-radius: 8px; 
            box-sizing: border-box; font-family: 'Sarabun', sans-serif; font-size: 14px;
        }
        
        /* Coordinate Input */
        #latlng-input {
            background-color: #f1f8ff;
            color: #0056b3;
            font-weight: bold;
            text-align: center;
            font-size: 12px;
        }

        /* Buttons */
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-locate { 
            background-color: #28a745; color: white; width: 100%; 
            margin-top: 5px; padding: 8px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        /* Popup Styling */
        .leaflet-popup-content { font-family: 'Sarabun', sans-serif; font-size: 14px; }
        .popup-header { font-weight: bold; color: #007bff; border-bottom: 1px solid #eee; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <button class="fab-btn" onclick="openForm()">+</button>

    <div id="modalForm" class="modal">
        <div class="modal-content">
            <h3 style="margin: 0 0 10px 0; text-align:center;">บันทึกข้อมูล</h3>
            
            <div class="form-group">
                <label>ปักหมุดตำแหน่ง</label>
                <div id="mini-map"></div> <input type="text" id="latlng-input" readonly value="กำลังโหลด...">
                
                <button class="btn btn-locate" onclick="getCurrentLocationForMiniMap()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
                    หาพิกัดปัจจุบัน
                </button>
            </div>

            <div class="form-group">
                <label>ประเภทสถานที่</label>
                <select id="placeType">
                    <option value="shop">ร้านค้า</option>
                    <option value="restaurant">ร้านอาหาร</option>
                    <option value="service">สถานบริการ</option>
                    <option value="residential">บ้านพักอาศัย</option>
                    <option value="wasteland">พื้นที่รกร้าง</option>
                    <option value="vacant">ที่ดินเปล่า</option>
                </select>
            </div>

            <div class="form-group">
                <label>รายละเอียด</label>
                <textarea id="details" rows="2" placeholder="เช่น ก๋วยเตี๋ยวเรือ, บ้านไม้ 2 ชั้น"></textarea>
            </div>

            <div class="form-group">
                <label>สถานะ</label>
                <select id="status">
                    <option value="Open">เปิดบริการ</option>
                    <option value="Closed">เลิกกิจการ</option>
                </select>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeForm()">ยกเลิก</button>
                <button class="btn btn-primary" onclick="submitForm()">บันทึก</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- CONFIG ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKJ_kAK7tDqM3mMXLy-P5Eid-0mLz64-jBvlXPr6jwEuCPUFC8VR8pzUrxgJuOTGdg/exec'; // ใส่ URL ของคุณ
        const START_LAT = 16.426;
        const START_LNG = 102.835;

        // --- MAIN MAP ---
        const map = L.map('map', { zoomControl: false }).setView([START_LAT, START_LNG], 16);
        
        // Layers for Main Map
        const cleanMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: 'CartoDB', maxZoom: 20
        }).addTo(map);
        
        const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri'
        });

        const labelMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png');

        L.control.layers(
            { "แผนที่": cleanMap, "ดาวเทียม": satelliteMap }, 
            { "ชื่อถนน": labelMap }
        ).addTo(map);
        
        L.control.zoom({ position: 'topright' }).addTo(map);

        // --- VARIABLES ---
        let allMarkers = L.layerGroup().addTo(map);
        
        // Mini Map Variables
        let miniMap = null;
        let miniMarker = null;

        const typeColors = {
            'shop': '#3498db', 'restaurant': '#e67e22', 'service': '#9b59b6',
            'residential': '#2ecc71', 'wasteland': '#7f8c8d', 'vacant': '#95a5a6'
        };

        // --- FUNCTIONS ---

        function formatThaiDate(dateString) {
            if (!dateString) return "-";
            return new Date(dateString).toLocaleString('th-TH', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        function loadData() {
            fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                allMarkers.clearLayers();
                data.forEach(row => {
                    const [timestamp, lat, lng, type, details, status] = row;
                    if(!isNaN(parseFloat(lat))) {
                        const marker = L.circleMarker([lat, lng], {
                            radius: 8, fillColor: typeColors[type] || 'red',
                            color: "#fff", weight: 2, fillOpacity: 0.9
                        });
                        marker.bindPopup(`
                            <div class="popup-header">${type}</div>
                            <b>สถานะ:</b> ${status}<br>
                            <b>รายละเอียด:</b> ${details}<br>
                            <small style="color:gray">${formatThaiDate(timestamp)}</small>
                        `);
                        allMarkers.addLayer(marker);
                    }
                });
            });
        }
        loadData();

        // --- MINI MAP LOGIC (หัวใจสำคัญของข้อนี้) ---

        function initMiniMap() {
            // ถ้าสร้างไว้แล้ว ไม่ต้องสร้างใหม่
            if (miniMap) return;

            // สร้างแผนที่เล็ก
            miniMap = L.map('mini-map', { 
                zoomControl: false, // ปิดปุ่มซูมเพื่อประหยัดที่
                attributionControl: false 
            });

            // ใช้ภาพถ่ายดาวเทียมในแผนที่เล็ก เพื่อให้เห็นหลังคาบ้านชัดๆ
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(miniMap);
            // เพิ่มเลเยอร์ชื่อถนนทับ เพื่อให้รู้ว่าอยู่ซอยไหน
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png').addTo(miniMap);
        }

        function openForm() {
            document.getElementById('modalForm').style.display = 'flex';
            
            // 1. เริ่มต้น Mini Map
            initMiniMap();

            // 2. หาจุดกึ่งกลางจากแผนที่ใหญ่ หรือจุดล่าสุด
            const center = map.getCenter();

            // 3. **สำคัญมาก** ต้องสั่ง invalidateSize หลังจากแสดง Modal ไม่งั้นแผนที่เทา
            setTimeout(() => {
                miniMap.invalidateSize();
                miniMap.setView(center, 18);
                updateMiniMarker(center.lat, center.lng);
            }, 200);
        }

        function updateMiniMarker(lat, lng) {
            // ถ้ามีหมุดเก่า ลบก่อน
            if (miniMarker) miniMap.removeLayer(miniMarker);

            // สร้างหมุดใหม่ที่ลากได้ (Draggable) บน Mini Map
            miniMarker = L.marker([lat, lng], { draggable: true }).addTo(miniMap);

            // อัพเดทตัวเลขพิกัด
            updateInput(lat, lng);

            // Event: เมื่อลากหมุดในแผนที่เล็ก
            miniMarker.on('drag', function(e) {
                const c = e.target.getLatLng();
                updateInput(c.lat, c.lng);
            });
        }

        function updateInput(lat, lng) {
            document.getElementById('latlng-input').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        function getCurrentLocationForMiniMap() {
            const btn = document.querySelector('.btn-locate');
            const oldText = btn.innerHTML;
            btn.innerHTML = '⏳ กำลังค้นหา...';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    const lat = p.coords.latitude;
                    const lng = p.coords.longitude;
                    
                    // ย้ายแผนที่เล็กไปจุดนั้น
                    miniMap.setView([lat, lng], 19);
                    updateMiniMarker(lat, lng);
                    
                    btn.innerHTML = oldText;
                }, () => {
                    alert('หาพิกัดไม่เจอ');
                    btn.innerHTML = oldText;
                }, {enableHighAccuracy: true});
            } else {
                alert('Browser ไม่รองรับ GPS');
            }
        }

        function closeForm() {
            document.getElementById('modalForm').style.display = 'none';
        }

        function submitForm() {
            if (!miniMarker) return alert('กรุณาระบุพิกัด');
            
            const latLng = miniMarker.getLatLng();
            const formData = {
                lat: latLng.lat,
                lng: latLng.lng,
                type: document.getElementById('placeType').value,
                details: document.getElementById('details').value,
                status: document.getElementById('status').value
            };

            const btn = document.querySelector('.btn-primary');
            btn.innerText = 'บันทึก...';
            btn.disabled = true;

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            }).then(() => {
                alert('บันทึกสำเร็จ');
                closeForm();
                loadData();
                document.getElementById('details').value = '';
                btn.innerText = 'บันทึก';
                btn.disabled = false;
            }).catch(err => {
                alert('Error'); 
                btn.disabled = false;
            });
        }

        window.onclick = function(e) {
            if (e.target == document.getElementById('modalForm')) closeForm();
        }
    </script>
</body>
</html>
