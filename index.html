<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Sarabun', sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à (Floating Action Button) */
        .fab-btn {
            position: absolute;
            bottom: 30px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 60px;
            font-size: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            cursor: pointer;
            border: none;
        }

        /* Modal Form Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-locate { background-color: #28a745; color: white; margin-top: 5px; width: 100%; }

        /* Custom Popup */
        .popup-content b { color: #007bff; }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <button class="fab-btn" onclick="openForm()">+</button>

    <div id="modalForm" class="modal">
        <div class="modal-content">
            <h3>‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô</h3>
            
            <div class="form-group">
                <label>‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö)</label>
                <div id="latlng-display" style="font-size:0.8em; color:gray;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏</div>
                <button class="btn btn-locate" onclick="getCurrentLocation()">üìç ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
            </div>

            <div class="form-group">
                <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label>
                <select id="placeType">
                    <option value="shop">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</option>
                    <option value="restaurant">‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</option>
                    <option value="service">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
                    <option value="residential">‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢</option>
                    <option value="wasteland">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏Å‡∏£‡πâ‡∏≤‡∏á</option>
                    <option value="vacant">‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏•‡πà‡∏≤</option>
                </select>
            </div>

            <div class="form-group">
                <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                <textarea id="details" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≤‡∏¢‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß, ‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß 3 ‡∏ä‡∏±‡πâ‡∏ô"></textarea>
            </div>

            <div class="form-group">
                <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                <select id="status">
                    <option value="Open">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                    <option value="Closed">‡∏õ‡∏¥‡∏î/‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</option>
                </select>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-primary" onclick="submitForm()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL (‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà) ---
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKJ_kAK7tDqM3mMXLy-P5Eid-0mLz64-jBvlXPr6jwEuCPUFC8VR8pzUrxgJuOTGdg/exec'; 

        // --- 2. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ---
        // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ñ‡∏ô‡∏ô‡∏®‡∏£‡∏µ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô
        const centerPoint = [16.426, 102.835]; 

        const map = L.map('map', {
            center: centerPoint,
            zoom: 16,
            zoomControl: false // ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡πÉ‡∏™‡πà custom ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ pinch zoom
        });

        // Layer: ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Clean (CartoDB Positron No Labels) - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡πÄ‡∏ô‡πâ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏õ‡∏•‡∏á/‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
        const cleanMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '&copy;OpenStreetMap, &copy;CartoDB',
            maxZoom: 20
        }).addTo(map);

        // Layer: ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Esri World Imagery)
        const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        // ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î Layer
        const baseMaps = {
            "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô (Clean)": cleanMap,
            "‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°": satelliteMap
        };
        L.control.layers(baseMaps).addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // --- 3. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏≥‡∏£‡∏ß‡∏à ---
        let tempMarker = null; // ‡∏´‡∏°‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ï‡∏≠‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
        let allMarkers = L.layerGroup().addTo(map);

        // ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
        const typeColors = {
            'shop': '#3498db',      // ‡∏ü‡πâ‡∏≤
            'restaurant': '#e67e22', // ‡∏™‡πâ‡∏°
            'service': '#9b59b6',   // ‡∏°‡πà‡∏ß‡∏á
            'residential': '#2ecc71',// ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
            'wasteland': '#7f8c8d', // ‡πÄ‡∏ó‡∏≤
            'vacant': '#95a5a6'     // ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô
        };

        // --- 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet ---
        function loadData() {
            fetch(SCRIPT_URL)
            .then(response => response.json())
            .then(data => {
                allMarkers.clearLayers(); // ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏Å‡πà‡∏≤
                data.forEach(row => {
                    // row format: [Timestamp, Lat, Lng, Type, Details, Status]
                    const lat = parseFloat(row[1]);
                    const lng = parseFloat(row[2]);
                    const type = row[3];
                    const details = row[4];
                    const status = row[5];

                    if(!isNaN(lat)) {
                        const color = typeColors[type] || 'red';
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Circle Marker
                        const marker = L.circleMarker([lat, lng], {
                            radius: 8,
                            fillColor: color,
                            color: "#fff",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });

                        // Popup ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        const popupContent = `
                            <div class="popup-content">
                                <b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</b> ${getTypeName(type)}<br>
                                <b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</b> ${status === 'Open' ? '<span style="color:green">‡πÄ‡∏õ‡∏¥‡∏î</span>' : '<span style="color:red">‡∏õ‡∏¥‡∏î</span>'}<br>
                                <b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${details}<br>
                                <hr>
                                <small><i>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°</i></small>
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                        allMarkers.addLayer(marker);
                    }
                });
            })
            .catch(err => console.error("Error loading data:", err));
        }

        function getTypeName(typeKey) {
            const names = {
                'shop': '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', 'restaurant': '‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£', 'service': '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£',
                'residential': '‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å', 'wasteland': '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏Å‡∏£‡πâ‡∏≤‡∏á', 'vacant': '‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÄ‡∏õ‡∏•‡πà‡∏≤'
            };
            return names[typeKey] || typeKey;
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
        loadData();

        // --- 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à ---
        
        function openForm() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
            const center = map.getCenter();
            createTempMarker(center.lat, center.lng);
            document.getElementById('modalForm').style.display = 'flex';
        }

        function closeForm() {
            document.getElementById('modalForm').style.display = 'none';
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }

        function createTempMarker(lat, lng) {
            if (tempMarker) map.removeLayer(tempMarker);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î Draggable (‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ)
            tempMarker = L.marker([lat, lng], { draggable: true }).addTo(map);
            
            updateLatLngDisplay(lat, lng);

            tempMarker.on('dragend', function(e) {
                const coord = e.target.getLatLng();
                updateLatLngDisplay(coord.lat, coord.lng);
            });
        }

        function updateLatLngDisplay(lat, lng) {
            document.getElementById('latlng-display').innerText = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 18);
                    createTempMarker(lat, lng);
                }, () => {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS');
                });
            } else {
                alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS');
            }
        }

        function submitForm() {
            if (!tempMarker) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î');
                return;
            }

            const latLng = tempMarker.getLatLng();
            const formData = {
                lat: latLng.lat,
                lng: latLng.lng,
                type: document.getElementById('placeType').value,
                details: document.getElementById('details').value,
                status: document.getElementById('status').value
            };

            // ‡πÅ‡∏™‡∏î‡∏á Loading ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° (Optional)
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerText;
            btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            btn.disabled = true;

            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Apps Script
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Apps Script Web App
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            }).then(() => {
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
                closeForm();
                loadData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà
                
                // Reset form
                document.getElementById('details').value = '';
                btn.innerText = originalText;
                btn.disabled = false;
            }).catch(err => {
                console.error(err);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                btn.innerText = originalText;
                btn.disabled = false;
            });
        }

        // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å Modal ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î
        window.onclick = function(event) {
            const modal = document.getElementById('modalForm');
            if (event.target == modal) {
                closeForm();
            }
        }
    </script>
</body>
</html>
